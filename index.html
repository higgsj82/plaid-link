<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Plaid Link</title>

    <!-- Plaid Link SDK -->
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        padding: 16px;
      }
      button {
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
      }
      button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      #status {
        margin-top: 10px;
        font-size: 12px;
        color: #6b7280;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <button id="open" disabled>Waiting for link token…</button>
    <div id="status"></div>

    <script>
      const btn = document.getElementById("open");
      const statusEl = document.getElementById("status");

      function setStatus(msg) {
        statusEl.textContent = msg || "";
      }

      window.addEventListener("message", (event) => {
        if (event.data?.type !== "SET_PLAID_LINK_TOKEN") return;

        const linkToken = event.data.link_token;

        if (!linkToken) {
          btn.disabled = true;
          btn.textContent = "Missing link token";
          setStatus("No link_token provided");
          return;
        }

        btn.disabled = false;
        btn.textContent = "Open Plaid Link";
        setStatus("");

        btn.onclick = () => {
          btn.disabled = true;
          btn.textContent = "Opening…";

          const handler = Plaid.create({
            token: linkToken,
            onSuccess: (public_token, metadata) => {
              window.parent.postMessage(
                { type: "PLAID_LINK_SUCCESS", public_token, metadata },
                "*"
              );
              btn.disabled = false;
              btn.textContent = "Open Plaid Link";
              setStatus("Success — public_token sent to parent.");
            },
            onExit: (err, metadata) => {
              window.parent.postMessage(
                { type: "PLAID_LINK_EXIT", err, metadata },
                "*"
              );
              btn.disabled = false;
              btn.textContent = "Open Plaid Link";
              setStatus(err ? "Exited with error (see console)" : "Exited.");
            }
          });

          handler.open();
        };
      });
    </script>
  </body>
</html>
